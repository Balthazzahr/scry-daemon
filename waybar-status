#!/usr/bin/env python3
import os
import sys
import time
import subprocess
from pathlib import Path
import config

JSON_FILE = config.WAYBAR_JSON_FILE

def is_running():
    try:
        # Use pgrep -x to match the process name exactly, or -f for full command line
        # We also filter out the helper script itself to avoid false positives
        pgrep = subprocess.run(['pgrep', '-f', 'scry_daemon.py'], capture_output=True, text=True)
        pids = pgrep.stdout.strip().split('\n')
        # Filter out own PID
        my_pid = str(os.getpid())
        active_pids = [p for p in pids if p and p != my_pid]
        return len(active_pids) > 0
    except:
        return False

def main():
    if not is_running():
        return # Returns nothing, making Waybar hide the module

    if not JSON_FILE.exists():
        return
        
    # Freshness check (10 mins)
    if time.time() - JSON_FILE.stat().st_mtime > 600:
        return

    try:
        with open(JSON_FILE, "r") as f:
            print(f.read().strip())
    except:
        pass

if __name__ == "__main__":
    main()
